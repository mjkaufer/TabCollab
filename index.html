<!DOCTYPE html>

<html>
	<head>
		<script src="js/wad.min.js"></script>
		<script src="js/DataChannel.js"></script>
		<title>TabCollab</title>
		<style>
			textarea{
				width:100%;
				height:60vh;
				font-family: monospace !important;
			}
			body{
				text-align: center;
			}
			div.friendTab{
				border: solid black 1px;
				border-radius: 1em;
				padding: 1em;
			}
			pre{
				text-align: left;
			}

			#tabs div{
				margin: 3em 0 !important;
			}

		</style>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
		<link rel="stylesheet" href="css/bootflat.min.css">
	</head>
	<body>
		<div class="col-md-8 col-md-offset-2">
			<div class="container-fluid">
				<h2>TabCollab</h2>
				<h5>By <a href="http://github.com/mjkaufer">Matthew Kaufer</a></h5>
				<p>Warning: Because of the way most browsers manage resources, <b>switching tabs will slow the current playback by <u>a lot</u>!</b></p>
			</div>

			<div class="container-fluid">
				<textarea id="tab">
e|-0-0-0---0-3-----|
B|-------1---------|
G|-----------0---0-|
D|-0-0-0-0---------|
A|-----------------|
E|---------------3-|
</textarea>
				</div>
				<br>
		</div>
		<div class="col-md-4 col-md-offset-4">
			<div class="container-fluid">
				<div class="form-group">

					<label for="speed"><b>Milliseconds per Note</b></label>
					
					<input id="speed" type="number" value="75" class="form-control">
					<br>
					<button class="btn btn-primary" id="play"><span class="glyphicon glyphicon-play"></span>&nbsp;Play Your Tab!</button>
					<br>
					<br>
					<button class="btn btn-danger" id="stop"><span class="glyphicon glyphicon-stop"></span>&nbsp;Stop</button>
					<br>
					<br>
					<button class="btn btn-success" id="sync"><span class="glyphicon glyphicon-refresh"></span>&nbsp;Sync</button>
					<br>
					<br>
					<button class="btn btn-info" id="playForAll"><span class="glyphicon glyphicon-volume-up"></span>&nbsp;Play Your Tab for Everyone</button>
					<br>
					<br>

					<div id="newRoom">
						<button class="btn btn-warning" id="room"><span class="glyphicon glyphicon-link"></span>&nbsp;New Room</button>
						<p id="roomInfo" style="display:none;">Have friends go to <a href="" id="roomLink">here</a> to share tabs with you!</p>
					</div>
				</div>
			</div>
		</div>

		<br>
		<br>

		<div class="col-md-8 col-md-offset-2">
			<div class="container-fluid">
		
				<div class="container-fluid">
					<div id="tabs">

					</div>
				</div>
			</div>
		</div>


		<script>

			var guitars = []
			var muted = [];

			var frequencies = [
				/*e*/[330, 349, 370, 392, 415, 440, 466, 494, 523, 554, 587, 622, 659, 698, 740, 784, 831, 880, 932, 988, 1047],
				/*b*/[247, 262, 277, 294, 311, 330, 349, 370, 392, 415, 440, 466, 494, 523, 554, 587, 622, 659, 698, 740, 784],
				/*g*/[196, 208, 220, 233, 247, 262, 277, 294, 311, 330, 349, 370, 392, 415, 440, 466, 494, 523, 554, 587, 622],
				/*d*/[147, 156, 165, 175, 185, 196, 208, 220, 233, 247, 262, 277, 294, 311, 330, 349, 370, 392, 415, 440, 466],
				/*a*/[110, 117, 123, 131, 139, 147, 156, 165, 175, 185, 196, 208, 220, 233, 247, 262, 277, 294, 311, 330, 349],
				/*E*/[82, 87, 92, 98, 104, 110, 117, 123, 131, 139, 147, 156, 165, 175, 185, 196, 208, 220, 233, 247, 262]
			]

			function makeGuitar(){
				var guitar = new Wad(Wad.presets.piano)
				guitar.source = "sawtooth"
				return guitar
			}

			function playNotes(arr){//arr is a 2 slot array, containing 6 slot arrays, with either a number (0-20, inclusive), or null
				var play = []
				var amount = 1;

				for(var i = 0; i < arr[0].length; i++){
					if(isNaN(arr[0][i]))
						continue;

					if(!isNaN(arr[1][i]))//if the next digit is _also_ a number (which means that the tab is something like 10)
						amount = 2
				}

				for(var i = 0; i < arr[0].length; i++){
					if(isNaN(arr[0][i]))
						continue;

					var freq = 0;
					var string = guitars[i];

					for(var j = 0; j < amount; j++){
						if(!isNaN(parseInt(arr[j][i]))){
							freq *= Math.pow(10, j)
							freq += parseInt(arr[j][i])	
						}
						
					}

					string.play({pitch: frequencies[i][freq]})
				}

				return amount
			}

			function mute(){// currently a bit buggy
				for(var i = 0; i < guitars.length; i++){
					// console.log(i)
					try{
						guitars[i].stop()	
					} catch(e){}
				}
			}

			for(var i = 0; i < frequencies.length; i++)
				guitars[i] = makeGuitar()

			var chordRegex = /[EBGDA]/gi;
			var breakRegex = /\-\|\-/g;

			function cleanTab(tab){
				for(var i = 0; i < tab.length; i++){
					tab[i] = tab[i].replace(chordRegex,"");
					tab[i] = tab[i].replace(breakRegex,"-");
					tab[i] = tab[i].replace(/\|/g, "");
				}

				return tab;
			}

			function addToSong(song, arr){
				for(var i = 0; i < song.length; i++)
					song[i] += arr[i]
				return song
			}

			function songToNotes(song, index){
				var ret = [];

				for(var i = 0; i < song.length; i++)
					ret.push(song[i].substr(index, 1))

				return ret
			}


			var index = 0;
			var musicInterval = 0;

			function playSong(song){
				index = 0;
				clearInterval(musicInterval)

				musicInterval = setInterval(function(){
					if(index >= song[0].length)
						// index %= song[0].length;//the show must go on!
						return clearInterval(musicInterval)

					var notes = songToNotes(song, index);
					var nextNotes = songToNotes(song, index+1);
					// mute();
					
					index+=playNotes([notes, nextNotes]);

				}, document.getElementById('speed').value)
			}

			var play = document.getElementById('play');

			function playClick(){
				var text = document.getElementById('tab').value;
				text = text.replace(/\n+/g, "\n").replace(/^\n/g,"").split("\n");

				var newSong = ["", "", "", "", "", ""]

				for(var i = 0; i < text.length; i++)
					newSong[i % newSong.length] += text[i]

				clearInterval(musicInterval)

				playSong(newSong)
			}

			function getUserPre(uid){

				return document.getElementById('tab-' + uid).getElementsByTagName('pre')[0];
			}

			function playTab(userid){
				var text = getUserPre(userid).textContent;
				text = text.replace(/\n+/g, "\n").replace(/^\n/g,"").split("\n");

				var newSong = ["", "", "", "", "", ""]

				for(var i = 0; i < text.length; i++)
					newSong[i % newSong.length] += text[i]

				clearInterval(musicInterval)

				playSong(newSong)
			}


			function syncMusic(){
				channel.send(["tab", document.getElementById('tab').value])
			}

			function playForAll(){
				channel.send(["playForAll", document.getElementById('tab').value])
			}

			play.onclick = function(){
				playClick()
			}

			var stop = document.getElementById('stop');

			stop.onclick = function(){
				clearInterval(musicInterval)
			}

			var sync = document.getElementById('sync');

			sync.onclick = function(){
				syncMusic();
			}

			document.getElementById('playForAll').onclick = function(){
				playForAll()
			}

			document.getElementById('tab').onkeyup = function(){
				syncMusic()
			}

			var room = document.getElementById('room');

			room.onclick = function(){
				room.style.display = "none"

				document.getElementById('roomInfo').style.display = ""

				var roomId = generateId()

				document.getElementById('roomLink').href = "?id=" + roomId

				// channel.open(roomId)
				window.location += "?id=" + roomId
			}

			function generateId(){
				return (Math.random() * new Date()).toString(16).replace(".","").substr(0,6)
			}

			function getParameterByName(name) {
				name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
				var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
				results = regex.exec(location.search);
				return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
			}

		</script>

		<script>
			var channel = new DataChannel();
			function createTabDiv(userid){
				var div = document.createElement('div');
				div.id = "tab-" + userid
				div.className = "friendTab"

				var who = document.createElement('h3');

				if(who.textContent == "")
					who.textContent = userid + "'s Tab";
				else if(who.innerHTML == "")
					who.innerHTML = userid + "'s Tab";

				var pre = document.createElement('pre');

				div.appendChild(who);
				div.appendChild(pre);

				document.getElementById('tabs').appendChild(div)
			}

			function removeTab(userid){
				document.getElementById('tabs').removeChild(document.getElementById(userid))
			}

			channel.onopen = function (userid) {
				createTabDiv(userid)
				syncMusic()
			};

			channel.onmessage = function (message, userid) {
				console.log(userid)

				var command = message[0];
				var body = message[1] || undefined;
				console.log(message)

				getUserPre(userid).textContent = body;

				if(command == "tab")
					return;//already did what we needed
				else if(command == "playForAll")
					if(!muted[userid])
						playTab(userid)
				
			};

			channel.onleave = function (userid) {
				removeTab(userid)
			};

			var roomId = getParameterByName("id");

			if(roomId != ""){
				setTimeout(function(){
					channel.open(roomId)	
				}, 500)
				
				channel.connect(roomId)

				room.style.display = "none"

				document.getElementById('roomInfo').style.display = ""

				document.getElementById('roomLink').href = "?id=" + roomId
			}

			// channel.open("test")
			// channel.connect("test")
			// channel.connect();
			// channel.open();

		
			</script>

	</body>
</html>